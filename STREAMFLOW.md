# Livepeer Streamflow白皮书

**在Ethereum上通过编排、概率微支付和离线作业协商实现Livepeer可伸缩性**

**作者**    
Doug Petkanics <doug@livepeer.org>    
Yondon Fu <yondon@livepeer.org>

**研究人员**    
Eric Tang <eric@livepeer.org>    
Philipp Angele <philipp@livepeer.org>    
Josh Allmann <josh@livepeer.org>

**状态: 提案-要求对这个早期提案进行反馈和审查。**

## 摘要 #####################################

Streamflow提议引入了对Livepeer协议和离线实现的更新，这将允许Livepeer扩展到超出部署到Ethereum区块链的alpha协议的当前限制。它建议对网络的可负担性、可靠性、性能和可伸缩性进行更新。介绍了关键要素包括服务注册中心,一个offchain工作谈判和支付机制,编制节点之间的分裂和代码转换节点,消除数据可用性问题的解决方案作为一个依赖不可靠的验证,和开放的节点数量,可以执行工作竞争低的网络上的任意限制在α。由此产生的体系结构将允许网络用户跨许多并发工作提供者在网络上执行大规模的代码转换工作，同时显著降低底层区块链的需求和价格波动对使用网络的经济可行性的影响。

## 目录 ###########################################

* [介绍和背景](#introduction-and-background)
* [Streamflow协议建议](#streamflow-protocol-proposal)
    * [协调器和转换器](#orchestrators-and-transcoders)
    * [放松译码器限制和股权强制执行安全](#relaxation-of-transcoder-limit-and-stake-enforced-security)
    * [服务注册中心](#service-registry)
    * [Offchain谈判工作](#offchain-job-negotiation)
    * [概率小额支付](#probabilistic-micropayments)
    * [基于故障的链验证](#fault-based-on-chain-verification)
* [经济分析](#economic-analysis)
    * [Livepeer代币](#livepeer-token)
    * [授权作为安全和信誉的信号](#delegation-as-security-and-reputational-signal)
    * [通货膨胀变成了束缚和冷漠的代表](#infaltion-into-bonded-state-and-apathetic-delegators)
    * [Offchain工程注意事项](#offchain-engineering-considerations)
* [攻击](#attacks)
    * [全权代表挤压](#delegator-squeezing)
    * [委托费用盗窃](#delegator-fee-theft)
* [开放的研究领域](#open-research-areas)
    * [不确定性验证](#non-deterministic-verification)
    * [公共转码器池协议](#public-transcoder-pool-protocols)
    * [广播双花缓解](#broadcaster-doublespend-mitigation)
    * [视频付款](#vod-payments)
* [迁移路径](#migration-path)
* [附录](#appendix)
    * [附录 A: 概率小额支付工作流)(# appendix-a-probabilistic-micropayments-workflow)
* [参考文献](#references)

## 介绍和背景 ###########################################

Livepeer协议激励和保护分散的视频编码节点网络。想要对视频进行代码转换的用户可以向网络提交一份工作，其价格是他们认为可以接受的，可以指定一个代码转换人员，可以在保证准确性的前提下执行视频代码转换。live协议使用基于委托利害关系的机制来选择那些被认为足够可靠和高质量的节点，以便及时和高性能地执行live视频编码。

目前部署在Ethereum区块链上的协议的alpha版本实现了[Livepeer白皮书]中最初指定的许多设计(https://github.com/livepeer/wiki/blob/master/WHITEPAPER.md)。基于委托利益的系统及其通货膨胀的激励措施已证明在鼓励参与方面是有效的，并已建立了一个由转码人员和委托人员组成的积极参与的早期网络，以执行相应的转码工作和质量保证。该网络是可用的，对于许多用例，例如长时间运行的实时代码转换，或分散的应用程序原型，在其早期阶段是一个可行的选择。但是，由于视频基础设施服务的规模化使用，alpha版存在以下不足:

1. 使用网络的成本与以太坊gas价格的波动关联太大，因此，在gas价格太高时，或者编码需要许多事务的场景时，相对于集中式替代方案，网络变得过于昂贵而不可行。
2. 基于利害关系的工作分配和链上转码协商为广播公司创建了不可靠的场景——如果分配给他们的转码器离线，他们在协商第二个转码器时会产生额外的成本和延迟，这在实时流媒体环境中可能会造成严重的破坏。
3. 数据可用性问题仍然没有解决(在生产中)，因此工作的验证不能完全缺乏信任和非交互式。
4. 编译器无法管理其执行或不执行任务的可用性，这取决于超出风险的容量和工作负载。
5. 虽然网络鼓励价格竞争，但它并不直接鼓励业绩竞争和问责制。
6. 目前由于以太坊gas限制和协议的实际实现将可以在任何时间处于活动状态的活动译码器的数量限制在非常低的水平，从而为进入网络竞争工作设置了很高的障碍。

本文的其余部分依次提出了解决这些弱点的解决方案。它首先描述了架构和协议更改建议。然后，在处理可能的攻击之前，分析这些变化对网络的经济影响。它接着承认了开放的研究领域，这些领域有助于将该提案从基于经济和社会/声誉的安全，转变为强大的、加密的安全。最后，如果社区愿意接受这些更改，那么它将对从alpha协议迁移到实时网络中的Streamflow的路径进行一些思考。

本文描述了概念协议的更改并分析了它们的影响，但是将实现这些更改的特定规范留给了附带的规范文档，作为Livepeer改进建议(LIP)过程的一部分提供。

_Note:要正确地吸收协议更新，重要的是理解当前Livepeer协议是如何工作的，如白皮书所述[[1](#references)]._


## Streamflow协议的建议 #################################

该提议向Livepeer生态系统引入了许多变化和新概念。每一个都在可负担性、性能、可靠性或可伸缩性的一个或多个领域产生影响。它们包括:

* 将编配员的新角色引入广播员及译码员的现有角色。
* 放宽对译码器数量的限制，让开放存取系统在任何有抱负的代币持有编配器之间竞争工作，以满足最低的利害关系和安全要求。
* 服务注册表，编配者在其中公布他们的可用功能和服务。
* 广播公司与协调器之间的场外价格谈判及工作分配。
* 使用概率微支付的离线支付，带有链上结算和保证金。
* 更新的验证流程，其中链上验证只需要在观察到故障的情况下进行。

### 协调器和转换器已经

目前，Livepeer网络上的转码器是一个协议感知节点，它既监视区块链协议，又与之交互，并执行视频转码工作。简而言之，它既可以在网络上编排工作，也可以对视频进行代码转换。这可能会造成性能和可靠性问题，并使节点难以扩展其操作。Streamflow提出了两层架构，其中包含以下部分:

* 协调器是协议感知的，与广播商协商工作，负责向广播商交付经过验证的转码段，并在潜在的大的转码器池中协调这项工作的执行。
* 一个不需要知道Livepeer staking协议或区块链的转码器，而只是具有竞争力的、成本效益好的硬件，它的唯一工作就是在编配人员的协调下，以尽可能低的成本和尽可能快的速度对视频进行编码。

<img src="https://livepeer-dev.s3.amazonaws.com/docs/otsplit.jpg" alt="Orchestrator Transcoder Split" style="width:750px">

这个体系结构的第一层类似于当前的Livepeer协议，其中当前的代码转换器被重命名为协调器。这些协调器将LPT作为赌注来提供针对其执行的工作的安全存款，这样，如果它们损害了网络，就会招致经济损失。广播公司知道这些编排器，与它们协商工作，并从它们那里接收转换后的段，如果编排器不诚实地执行工作，广播公司可以删除编排器。

这个体系结构的第二层是一个称为代码转换池的新概念。实际上，尽可能快、尽可能低成本地执行视频代码转换的工作可以由具有可用容量的gpu来完成，比如video Miner提案[[2](#references)]中描述的gpu，它们闲置着NVENC asics。这个硬件就可以执行实际的编码工作,竞争和竞争力量和经济会导致比如果协调器自己需要更便宜的价格来执行所需的处理相同的基于CPU的设置运行区块链和协议了解网络上的编排。

这类似于当前的加密货币挖掘池，其中池本身的实现可以是集中式的，也可以是分散式的;它们可以由中央池运营商自己运行，也可以向世界各地的数百万台可用计算机开放，这些计算机都在竞相开采下一个区块。一个协调器可以提供代码转换为自己的池如果他们想,导致相同的设置存在于今天Livepeer协议,尽管这样做他们需要专家两个单独的和不同的工作,他们与那些开放的协调器池可能更快或更便宜转码的来源。另一方面，如果编排器运行自己的池，那么它们可以信任视频编码，而不需要验证不受信任的公共译码器的工作。

这种两层结构的一些好处包括:

* 任何想要赚钱的人都可以通过简单地打开他们的硬件，让它竞相执行可用的代码转换工作来实现这一点。不需要链上知识、加密货币、赌注、存款等。这就像任何人都可以通过挖矿来获得比特币一样。然而，尽管每个人都可以访问并参与竞争，但在电力、带宽和地理定位方面具有优势的译码器可能会比那些没有这些竞争性设置的译码器运行得更好。
* 广播公司获得编配器的池安全性，但是底层的扩展实现和公共和私有池的安全性可以留给Livepeer协议范围之外的试验。
* 协调器可以专注于协议交互和安全性的正确操作，而不是专注于扩展硬件。一个编配器可以同时编排数百个流，而不需要对视频本身进行代码转换。
* 可以使用其他的转码器池实现，利用gpu、分布式设置来竞争不同地区的工作，并鼓励竞争，这将为广播公司带来最便宜的可用价格。

虽然本文将描述用于广播/编配通信和安全的协议，但它将编配/转码协议的第二层留给不同的实现。在简单的情况下自己的一个协调器代码转换器池,然后协议的安全,而其他信任/性能权衡可以替代实现协调池,从集中式和信任,分散担保在层两个区块链建立股权和存款。理论上，由于在公共池中对随机参与者执行的工作进行验证会带来额外的成本，因此私有池的性能可能优于公共池，但是这可以通过可靠的加密经济存储、削减和验证协议来克服。


### 放松译码器限制和桩强制安全

Streamflow提出的第二个主要更改是放松对活动Transcoders (Streamflow中的协调器)数量的人为限制。在genesis中，这个参数被设置为10，之后扩展到15，但是这仍然造成了进入的主要障碍，因为节点需要越来越多的LPT来进入活动池。在Streamflow中，目标是消除这个任意限制，并允许以利害关系(或委托利害关系)访问的形式提供足够安全的任何节点在网络上竞争。

限制的原因首先是:

* 将工作链上分配给活动的译码器后，关键是它们必须在线并可用于执行工作。对这个职位的可用性的限制，以及他们的统计数据和性能的容易可见性，有助于确保高质量的网络。
* 以太坊gas对计算和记账的限制围绕这一活动集，创造了一个人为的限制，它仍然可以扩展到当前点以外，但不是一个数量级。
* 在alpha测试期间，与活动集保持密切的联系和协调是非常重要的，这样他们就可以频繁地更新软件，响应bug，并帮助开发和QA网络。
* 活跃的译码员需要有足够的风险来保证网络的安全，这样，如果他们作弊，就会受到严重的经济惩罚。

减少这一人为限制的影响将通过以下方式实现:

* 离线作业协商和故障转移，这意味着无法工作或无法执行工作的编配人员将失去未来的工作，但不会影响广播人员的体验。
* 活动集不必每轮计算一次，相反，可以作为协调器键、取消键或被删除来维护。
* 活跃的、有竞争力的编配人员仍然希望密切关注网络的升级、bug和开发——但是不活跃的编配人员将无法在不影响广播体验的情况下吸引网络上的工作。
* 既然初始利害关系的很大一部分是积极参与的，那么可以设置足够的利害关系和安全性，以保护更多的节点在网络上竞争工作。

目标协调器的确切数量和实现方法仍然是一个有待研究的问题。最初，应该有一个数量级的增长——例如数百个活动协调器，而不是15个——最终的目标是扩展到1000个，以便为世界上每个地区的每个服务提供冗余。以下是一些经过深思熟虑的机制，并简要描述了它们的一些权衡:

1. **将N(编配槽的#)从15扩展到更大的值，比如200**: 事情基本上会像今天这样工作，激活一个节点的进入壁垒要低得多。但这将使建立联系的相关行动更加昂贵。以太结垢和气体问题可能会发挥作用。
2. **设置成为协调器所需的最小利害关系**: 这将建立一个最大可能的“N”,同时允许任何人知道如何实现这一安全栏和保持活跃集。它还将启用一个扩大网络协调器的通胀下生成的,并鼓励积极寻找新的潜在的协调器提供费用有股票,谁正在寻找超过最低成为活跃的工作竞争。
3. **为任何协调器设置固定的利害关系**: 这将迫使编排器运行额外的节点，并使委托器不断地进行重新设置，以便使用它们的膨胀式LPT。但是，它在协调器和委托器的最终用户体验方面存在一些弱点，以及一些复杂的实现细节。
4. **从协议中消除任何最小利害关系要求，并让客户端配置保护作业所需的利害关系**: 这将创建最开放、最分散的最初,但是它提供了至少令牌持有有之间的协调和协调器将创建一个高质量的网络——本质上名声扮演更重要的角色,因此它可能导致更多的集中的长期工作中有更少的集体能力有路由的工作。

的好处和缺点上面的方法正在考虑中,重要的是要注意,结果实现了从实施任何上述将扩大协调器网络,更多的冗余和竞争提供给广播的好处,和持续激励路由股份向节点可以执行额外的服务可靠和成本有效的网络,以换取费用。

最小利害关系模型的好处之一是，随着费用在网络中流动，几乎没有理由运行一个没有竞争网络工作的节点。插槽的数量是有限的，而且这部分股份最好是委托给一个能够提供费用分成的节点，而不是简单地坐在一个空闲的节点上，只收取报酬。


### 服务注册中心

Streamflow扩展了服务注册中心在on chain协议中的角色。协调器将继续宣传他们的`rewardCut`, `feeShare`,和连接信息，但是他们也将宣传他们的节点正在提供的服务，以及他们的节点正在服务的区域。这将导致性能影响，广播公司可以查找他们想要的特定服务，由附近的节点提供。由于价格和可用性协商正在脱离链，协调器将不再宣传他们正在收取的价格。对于经过考虑的服务，可能有两个抽象概念:

1. **服务**
    1. 服务标识符——表示此特定服务的id，如“CPUTranscoding”、“GPUTranscoding”或“SegmentVerification”。在准确的定义上还有很多工作要做，服务可能更细粒度，比如输入/输出编码对，比如“H264 1080p -> 720p”。
    2. 验证函数——指向验证函数的地址指针，该函数将在链验证此服务的正确性时运行(如果没有可用的验证，则可以为null)。
2. **位置**
    1. 实现是TBD，但这可能是一个抽象，指定了该节点愿意或能够服务的区域数组。

这些广告组合起来，广播公司将能够过滤服务注册中心中的节点，这些节点正在为它们希望提供的服务和位置做广告，以便在开始与适当的服务提供商进行非正式谈判时更有效率。位置是一个此前被忽略的因素Livepeer的alpha版本,但是它可以视频直播摄取的关键节点接收视频位于靠近视频源,由于各种网络问题可能发生和造成不稳定。
当然，广告中的位置可能是伪造的，但是，就像流的许多方面一样，客户端实现将很快发现并过滤掉性能不佳的编排器，从而使它们无法完成未来的工作并赚取费用。诚实地执行节点，最大限度地利用客户计算的广播公司成功关系、费用和声誉统计数据，可能会宣传有用的位置信息，从而成功地谈判、分配和可持续的长期运行工作。

以节点获得通胀下,为了把它优化使用,他们能做的最有效的事情是添加一个新的节点功能或服务的服务注册中心位置的需求,但是不够可靠或成本有效供给,因此扩大网络的足迹和能力为各种客户服务和用例。

### Offchain谈判工作
从链上作业分配到链外作业协商的转变可能是Streamflow提出的最大变化。它改变了严格按照利害关系来路由工作的假设，下面的分析部分将对此进行分析，但是它也带来了巨大的好处。即:

* **可用性** - 广播公司将能够确保在与协调器员签订合同之前，协调器是可用的。
* **冗余** - 如果在作业之前或期间某个编排器不可用，只需切换到另一个编排器即可。或者为了冗余而首先使用多个协调器。
* **速度** - 立即开始工作。没有必要等待on chain的确认。
* **成本效益** - 验证者验证广播器的on-chain PM store，如果存储级别足够，则执行将编码段发送回广播器的工作。

为了进行谈判，广播公司将与下列协议进行互动:

1. 读取服务注册表，并扫描所有匹配其请求的服务和位置参数的可用协调器，以获得所需的最小利害关系。
2. 然后，他们将使用所提供的连接信息来pin作业请求包含请求的服务和请求的位置(可选)。g每个人的作业请求。
3. 作业请求包含请求的服务和请求的位置(可选)。
4. 如果协调器希望竞争此任务并具有当前可用性，则会尽快响应，提供执行此任务的报价。
5. 协调器的报价中还包括概率微支付(PM)参数(如下所述)。
6. 广播器收集此响应数据，以及来自协调器的响应时间。
7. 他们运行自己的内部算法，考虑到响应时间、价格、过去的工作历史、PM参数、冗余需求、利害关系形式的安全性等方面的首选项，以便选择要使用哪个协调器。
8. 他们开始向选定的协调器发送视频片段和PM票据。
9. 配器验证广播器的on chain PM存储，如果存储级别足够，则执行将编码段发送回广播器的工作。

显然，该协议的第5步留给实现的工作还有很多。这里的总结是，广播公司可以选择他们自己的编曲人员，他们不需要连续不断地宣布或分配工作。

如果他们愿意，他们可以使用自己的编排器，然后当他们达到自己的计算能力时，开始只向另一个候选对象发送段。它们可以使用与它们有长期关系的同一节点，并且只有在该节点宕机或不可用时才切换到另一个节点。他们可以从5x冗余CPU编码开始为一个非常重要的高级实时流，或者他们可以使用世界上最便宜的GPU编码为一个非常低的可靠性随需工作，以节省成本。

<img src="https://livepeer-dev.s3.amazonaws.com/docs/pricenegotiation.jpg" alt="Offchain Job Negotiation" style="width: 750px">

切换和增加冗余不会给广播服务器带来任何on链事务开销，而在协议的alpha版本中，切换需要额外的on链事务和15-30秒以上的确认时间。

注意，步骤1-4可以选择在后台持续执行，而不是在流初始时执行。如果广播公司正在处理许多并发流，他们可能会发现为所有可用的编排器保留一个最新的price/service表是值得的，这样他们就可以在任何流上的任何时刻开始使用一个。


### 概率小额支付
流对成本节约的最大影响将来自这个概率微支付(PM)提议。以前，协议使用deposit() -> job() -> claim() -> verify() -> distributeFees()事务流来释放执行工作的付款。平均每1000个视频片段(或更多)需要执行其中的最后三个事务，而在短时间内执行5个事务对代码转换器来说成本太高。

关于PM的背景，建议回顾一下Orchid协议团队的一篇关于它在分散式VPN网络中的使用的文章，以及之前的学术研究[[3,4,5](#references)]。总结是，广播公司向协调器发出已签名的票证和工作的每个部分。如果彩票“赢了”，那么它的面值就会很高，这就允许编配者以这么高的金额在链条上兑现它。然而，it中奖的可能性非常低，所以每张彩票的期望值都是广播员和编导达成一致的价格/片段。从长远来看，广播公司将几乎完全按照他们同意的每一段向转码器支付费用，而转码器将几乎完全按照他们所做的工作的正确金额支付费用，这取决于工作的可能性。

通过使用PM，收集支付的成本可以是单个轻量级事务的成本，并且收集到的支付金额可以有效地批量处理为编排器愿意兑现的任何金额。例如，协调器总是可以以ETH的10美元现金支付，而由于gas价格导致的票面兑现成本可能是0.10美元，而开销只有1%。如果gas价格上涨10倍，协调者可以用现金支付100美元，保持1%的管理费用不变，或者他们可以吸收更多的管理费用，如果他们想要有竞争力的话。与推动许多流建议更新的理念相适应，它将是市场驱动的，并且客户端可配置，而不是强制执行协议。

当协调器兑现时，广播公司的支付能力通过链结、锁定时间的存款和罚款托管得到保证。

由于offchain工作谈判和潜在的冗余广播公司可能需要,他们可以送点门票在许多协调器,启动和停止工作在任何时间与任何一个协调器,同样,协调器可以在任何时候停止执行工作的广播公司,如果他们确定他们不支付正确或想去离线。这极大地改变了思维模型，从Livepeer中的“工作”变成了一个完整的连续流，变成了一个带有单个PM票证的视频片段。

完整的PM工作流程留给了[附录](#appendix)，因为它涉及到验证、off - chain协商和许多其他领域，比如双倍开销风险和缓解。

### 基于故障的链验证
Streamflow提出的最后一个主要更改是调整验证协议，以降低成本，避免数据可用性问题。在此之前，编译器需要为每一个`VerificationRate`段调用1个Truebit验证，这个值最初设置为1000个段中的1个。这是非常昂贵的，并且是必要的，无论转码器是否正确地工作。新的建议是:

* 广播公司有责任验证接收到的转码段，只有当他们认为转码段没有通过验证时，才向他们发出Truebit on chain的挑战。
* 如果Truebit(或其他适当的链验证功能)同意，那么编曲者的股份将被削减，广播公司将得到一笔可观的奖金。

<img src="https://livepeer-dev.s3.amazonaws.com/docs/faultverification.jpg" alt="Fault Based Verificaiton">

反对这种方法的部分理由是，广播公司没有足够的计算资源来重新编码视频，以检查工作是否正确完成。然而，使用与原始协议相同的随机方法，广播员可以从`VerificationRate`片段中检出1个片段。如果需要更高的可靠性，它可以进行更多的检查，或者它可以将检查外包给网络上的另一个节点，并支付该节点的费用，让该节点代表它高效地进行检查——这相当于为`VerificationRate`段中的一个部分雇佣第二个协调器。他们可以在主要工作中使用廉价的协调器，但是依赖于高声誉、高成本的协调器作为更可信的验证器。通过分析输出视频的帧数，而不是完全重新编码，比如基于度量的验证，还可以进行更便宜的检查。这些廉价的检查可以用来测试是否存在可能的错误，只有在这种情况下，然后在向Truebit提出挑战之前重新编码。

然而，关键的一点是，编排器不知道哪些段将受到挑战，如果任何段验证失败，它将损失大量的风险。作弊的好处将不得不超过完全削减的固定股本存款的价值，而这在许多用例中是不太可能的。此外，由于广播公司可能使用冗余，如果它检测到不一致，或者怀疑廉价的签退重新编码操作存在欺骗行为，它可以简单地选择与该段上的另一个编配器合作，以获得正确的编码并将其插入其播放列表。

这样做的一个影响是，Truebit的成本不需要产生，除非出现明显的欺骗——因此几乎不需要，因为对于一个编配者来说，故意欺骗是不值得的。这使得网络的使用成本远低于对每个`verificationRate`视频片段调用Truebit的成本。


## 经济分析 #################################

Streamflow提出的更改将导致对协调器和委托器的激励和行为略有不同，从而形成一个更具可伸缩性、可靠性和成本效益的网络。本节开始对这些提议的更改进行经济影响分析，包括Livepeer代币的作用、委托的作用、通货膨胀如何影响网络，以及一些离线的经济考虑。

### Livepeer代币

Livepeer代币(LPT)总是可以描述为工作代币。那些赌上它的人有机会在网络上工作，并因此赚取未来的费用(在ETH)。如果所有节点提供的价格都是恒定的，则工作的路由与股份成正比。对于“工作需求”，从一开始就有了设想的机制，即如果一个节点在其所占股份的某个阈值比例内没有执行足够的工作，那么就可以削减它们。这是一种尝试，旨在确保节点能够真正贡献价值(或者因为不这样做或伪造而招致间接费用)，而不是坐视不管，导致通胀。此外，并没有要求以有效的成本或绩效的方式完成工作。竞争可以得到社会鼓励，但不能在协议层面强制执行。

对协议的更新放松了人为限制的协调器数量，而离线作业协商似乎改变了代币和在表面上工作的权利之间的这种直接联系，但经过进一步分析，在平衡状态下积累了相同的值。让我们看看代币持有者试图最大化的函数:

`Value accrued in a single round = inflationary LPT earned + fees earned.`

膨胀的LPT是可预测的，基于编排器的报酬削减。委派者可以精确地选择他们希望获得多少LPT来交换他们正在做的QA工作。

另一方面，所赚取的费用对代币持有人的控制较少。这是因为它取决于:

1. 他们的编配器执行了多少工作
2. 协调器的 `feeShare`
3. 分配给协调器的总股份有多少，因此他们有权获得的费用池的百分比是多少

在一轮结束时，授权者将能够计算他们所押注的LPT的盈利能力。就是这个费用比率:

`ETH in fees / unit of staked LPT`

这将是委托方用来相互比较协调器的可见统计数据，并且可以预见，委托应该从一个轮转到另一个轮，转向有机会最大化此比例的节点。简而言之，为什么要坚持使用共享1gwei / LPT staked的节点，而可以切换到共享2gwei / LPT staked的另一个节点呢?

<img src="https://livepeer-dev.s3.amazonaws.com/docs/feeratio.jpg" alt="Fee Ratio">

但值得注意的是，将更多的股份转移到这个机会主义节点的行为，意味着费用将在更多的股份中分配，费用比例将会降低。均衡状态是执行更多工作(赚取更多)的节点拥有更多的股权，而执行较少工作、具有相同费用份额的节点拥有更少的股权。本质上，所有具有竞争力的节点最终都应该拥有相同的均衡费用比率，智能分配的股权将为委托方带来均衡回报——因此，智能分配的LPT将获得在网络上工作的机会，从而独立于工作的分配方式来赚取费用。

### 授权是安全和声誉的信号

人们可以预见的一个负面结果是，赢得大量工作的节点可以提供0%的费用份额，因此不会吸引任何委托。这是可以的-他们正在运行的硬件和成本，并提供良好的服务，为网络-他们可能不需要委托。但另一方面，授权提供了更多的安全保障——如果节点作弊，可以削减的风险更大——更多的声誉信号。客户使用这个信号来选择要合作的节点，因此，如果一个竞争性的节点打出了> 0%费用份额的广告，那么它更有可能吸引到股份，从而产生效果——只要它们能够以竞争性的方式执行，或者比0%费用份额节点更好，或者更便宜。同样，这有助于网络的灵活设置和用例。它增加了网络竞争、分散化、多样性和弹性的机会。

由于新节点希望在网络上竞争，它们可能需要吸引足够多的股份来提供广播公司所需的安全保障。在这些情况下，这些节点可能会设置更大的费用份额。活跃的委派者将有机会搜索并锁定那些赢得超大份额作品的节点，获得更高的费用份额，从而导致更高的费用比例。简而言之，委派的股权可以提供安全和路由工作，作为交换，当工作执行得很好时，可以分享回来的费用。主动委托可以使更多的机会节点能够以一种竞争的方式扩展网络的占用空间和功能。


### 通货膨胀变成了束缚和冷漠的代表
对没有最小利害关系的无上限利害关系模型的批评之一是，它支持代表委托方的懒惰行为。膨胀的LPT继续累积到绑定状态，继续复合，并允许委托方在收集LPT的同时设置它和忘记它，而不会给网络增加显著的价值。
在网络的早期可能是这样的情况，在收费成为委派者采取行动的额外激励之前，但是当协调者竞争工作、赚取和分配费用时，不太可能产生最大的结果。在这一点上，自动驾驶行为可能仍然会导致累积LPT，但是将会放弃通过切换到产生更高ETH/staked LPT比率的协调器而获得的潜在费用。

由于通货膨胀率在按比例使用的情况下可能会下降，当代币持有者押注于竞争以赚取费用时，由通货膨胀LPT所占的奖励功能的部分也会继续下降，其中很大一部分来自费用。正如上面LPT部分所述，不断地对网络进行质量保证，并将工作路由到比其他节点更具竞争力的节点，这种必要性在财务上是由机会主义回报驱动的。简而言之，一个冷漠的委派者比一个积极的委派者得到的回报要少。

此外，作为曾经需要吸引外部委托以实现最低利益的协调者，他们自己积累了足够的利益来保护自己的节点，因此他们可能会减少自己的费用份额。在这个阶段，一个优化的委派者最好是寻找一个新的有前途的节点——本质上是一个可以扩展网络足迹的节点——这个节点可以提供更高的费用份额来吸引股份。正是这种由优化的委托方执行的持续质量保证，以及以费用为代价的权衡，将产生持续的竞争，并进一步分散网络。

### Offchain工程注意事项
正如前面提到的，Streamflow中的核心理念之一是将关于有效参数值和p2p交互的许多观点从核心协议转移到客户机实现和配置中。这些参数的多种实现和配置将导致一个健壮的网络，它不容易受到攻击和恶意行为者的攻击。然而，由于协议本身不那么固执己见，因此有很多工作留给客户机实现。下面是一些需要从工程角度进行的主要考虑，以使流工作真正有效地开箱即用:

* PM风险管理策略——编配人员应该与广播公司合作还是不与广播公司合作，取决于声誉和历史，反之亦然。
* 为PM协议生成安全随机数。
* 协调器的DDoS阻力。
* 针对不同场景和用例的广播器的冗余和故障转移算法。
* 广播公司的价格发现策略。
* 低延迟流协议和签名/支付验证，当最终段不可用时，在工作开始前。

从广播公司的角度来看，低延迟流协议和签名/支付验证，当最终段不可用时，在工作开始前。上述每一项都可能影响网络的效率，从而导致必要的裁员，并最终导致成本上升。好消息是，上面的大部分都可以通过off - chain策略来处理，并且可以在不同的实现或配置之间不断地进行试验。如果网络中的代理以不同的、不可预测的方式运行，则很难对攻击者进行优化，否则攻击者就会试图利用单个实现进行攻击。


## 攻击 ###############################
一些特定的子协议，例如基于PM和Truebit的验证，都受到它们自己的攻击，我们将这些攻击留在这些研究领域内进行分析。 以下是Streamflow对协议变更的经济学中潜在攻击和对策的简要讨论。

### 全权代表挤压

当候选人协调器想要操作节点并表达他们的候选资格时，他们可能需要吸引授权以达到客户指定的最低存款金额以吸引主流工作。 要做到这一点，它们可能代表一种有吸引力的`RewardCut`和`FeeShare`。 然而，随着他们的节点开始工作，他们开始赚取通胀LPT，他们可能希望使用这个LPT更多地投入他们的单个节点，以减少他们需要与他们的委托人分享的通货膨胀和费用。 要做到这一点，他们可能会通过将他们的`RewardCut`和`FeeShare`操纵到一个没有吸引力的点来驱逐当前的委托人，然后用他们自己的赌注来弥补差距。

理论上这是可以的，因为委派者可以转移到更有吸引力的节点上，并根据自己的最大兴趣进行调整。不幸的是，它创建了一个令人讨厌的UX，因为委派者需要时刻保持警惕并积极地按照他们的最佳利益进行操作。每轮融资中，股票都有可能从其下方转出。

有一种观点认为，那些希望运行额外节点、维护良好声誉以吸引重要委托并为收费而竞争的协调器，其声誉将受到这种方法的损害，并且不会吸引未来的委托。

### 委托费用盗窃

正如在上面的委托器压缩攻击中提到的，协调器可以赶走它的委托。如果协调器在委托方离开之前一直持有赢得的PM票据，然后在包含其节点的所有利害关系时兑现它们，那么这可能成为一种特别恶意的技术。本质上，委托有权获得的费用和奖励将交付给协调器。

这可以通过在下午票上注明到期日来抵消，这发生在广播公司锁定存款的提取日期之前。因此，票券需要在短时间内兑现，并可能包含当时已提交的编排者的费用份额，以便在兑现中奖票券时可以在委派者和编排者之间进行适当的分割。


## 开放的研究领域 ############################

与基于区块链的密码经济协议的早期研究工作一样，在系统实现完全的分散化、可靠性和经济效率之前，仍有许多需要研究的问题。以下是该项目正在积极开展研究的几个领域。欢迎社区参与推动这些领域的发展。

### 不确定性验证

研究还在继续，以验证GPU编码的段表示与预编码段相同内容的可能性。这种以概率和度量为驱动的方法已经在实验和早期研究中得到了证明，可以得到准确的分数，但是基于概率结果实际削减存款的适用性肯定是有争议的，需要进一步的研究。

另一方面，确定性编码可以通过各种验证方案继续进行检查，包括Truebit、基于SGX的硬件验证、Oracles，甚至是可信校验器。

### 公共转码器池协议

编排职责和代码转换职责之间的划分应该有助于显著地扩展Livepeer上节点的操作，方法是利用空闲硬件对视频进行代码转换，而不必要求所有这些机器都24/7支持Livepeer操作的带桩节点。人们相信私有池(编配器也包含这种代码转换硬件)将是最经济有效的，因为编配器可以相信来自编配器的结果是正确的，而不是恶意的。

在公共池中，编配器不信任代码转换程序，但允许任何人选择快速地转换代码段，这在利用任何空闲计算方面可能非常强大，而不必自己拥有专用的基础设施。然而，由于这些远程代码转换节点不受信任，编排器将不得不检查它们的工作，否则就有被削减的风险。这将带来额外的成本，因此可能不太可能与私人泳池竞争——除非能够制定经济协议，以保证金的形式确保这些公共泳池的安全。如果可以显示某个特定的未知转码器是被调用的大幅削减条件的结果，并且它们有足够的存款/股份来支付大幅削减的成本，那么公共池可能是可行的。

这里的进一步研究和设计是一个开放的课题。

### 广播双重缓解

在概率性的小额支付方案中，总是存在这样一种可能性，即广播公司发行的中奖彩票数量超过了(意外)他们需要支付的余额。由于协调器可能不会立即通知广播公司中奖的消息，因此很难准确计算广播公司的余额。我们正在继续研究所需的参数和存款管理，以避免在网络的各种使用模式下意外的重复支出。请参阅概率微支付附录中的进一步分析。

### 视频付款

广播公司在视频点播转码时可能会寻找的一个很好的属性是，他们可以使内容可用，请求作业并消失 - 这样Orchestrator可以异步执行作业，分发它 跨越许多节点，或在有空闲资源时安排它。

但是，在Streamflow中描述的PM方案中，Broadcaster需要联机才能连续发送付款作为内容流。 部分安全性是承认如果Orchestrator不继续工作，那就没关系，因为Broadcaster将停止发送未来的付款。

然而，对于点播工作，如果广播公司预先支付所有视频片段的费用，然后离线消失，就没有安全措施来保证编配人员将执行代码转换，或将代码转换后的片段提供给广播公司。目前，视频点播转码是可能的，但上传和消失是不可能的。将继续研究更好的机制，使点播支付成为可能。

## 迁移路径 ############################

Streamflow在其研究、设计、反馈和实现周期中处于早期阶段。在将Ethereum主网作为Livepeer alpha协议上的下一个迭代投入使用之前，它当然需要一个完整的社区评论、测试、审计和验收。本节的目的是列出一些关于协议迁移如何发生的早期考虑:

* 新的智能契约逻辑将部署到Ethereum，但是预计几乎不需要数据迁移。可以使用Livepeer现有的代理-delegatecall更新机制。
* Livepeer协议中现有的状态，包括建立平衡、费用、奖励、授权等，将被保留。
* 翻译人员、广播人员、编配人员和委托人员将更新他们的客户端软件，其中将包含工作协商、冗余、支付和更新验证的逻辑。
* 协调器将向服务注册中心注册任何新的必需参数，包括受支持的服务和可能的位置。
* 广播公司将建立PM合同和存款。无论何时请求，现有的存款都可以通过用户驱动的操作从Minter迁移到PM契约。
* 预计这可以在协议几乎没有停机的情况下完成。
* 第三方客户端(如协议探索者和分析工具)可能需要更新，以反映新的协议交互。

随着候选流发布日期的临近，随着时间的推移，正式的迁移路径、检查表和多个观察到的testnet运行将变得可用。

## 总结 #################################

总之,本文档中包含的建议旨在揭露Livepeer视频的道路上一个可伸缩的基础设施网络——一个将使用成本Ethereum区块链从使用网络本身的成本,并提供现有扩展视频开发者的可靠性和性能,他们需要从基础设施。

欢迎所有的反馈、想法和意见，所以请不要犹豫来 [Livepeer论坛](https://forum.livepeer.org)讨论 或参与 [Discord聊天](https://discord.gg/RR4kFAh) 。


## 附录 ################################

### 附录 A: 概率小额支付流程

* 协调者的保证金是他们的赌注。如果他们作弊并没有通过验证，那么这个值就会被削减。
* 广播公司(使用这个术语来表示普通用户，他们可能更多的是开发人员而不是广播公司)支付一笔有时限的定金，以覆盖他们将在网络上支付的未来工作。
* 广播公司想要视频转码。他们查看为其服务做广告的编配人员的链上注册表，并与符合其需求的编配人员进行链外谈判:
    * 协调器为它们提供一个报价。
    * 协调器提供了概率微支付(PM)参数——这些参数可以根据以太网络条件而变化。例如，他们可以设置中奖金额，使兑现的成本低于收到的价值的1%。
* 广播公司将视频片段连同PM ticket一起发送给他们想要合作的编曲人员。
    * PM ticket是一种交互式协议，目的是防止任何一方歪曲用于确定某个ticket是否获胜的随机性源——在每个获胜ticket之后，编配人员需要生成一个新的random #并将承诺发送给广播机构。这可能没有问题，因为广播公司和编配人员已经在来回发送数据了——这只需要编配人员在每次需要新的承诺时发送一条额外的消息。后面的优化,可能是使用一个可核查的随机函数(多联机)中实现智能合同,协调器将广播一个酒吧密钥和协调器收到票,相应的迹象priv关键——多联机的合同将验证签名是正确的然后作为伪随机数的来源。因此，协议变得非交互式。需要评估在智能合同中实现VRF的可行性，以及验证这种类型的sig的成本——好吧，现在不关注这个，但未来的可能性。
* 广播器从编配器接收转换后的输出。
    * 广播公司可以验证它想要检查的任何片段。
    * 如果工作没有得到验证，他们可以提供这个证明给Truebit on chain来削减编制器，并获得巨大的回报。
* 如果广播公司没有从编配器接收回工作，只需停止向它们发送将来的片段，并使用不同的编配器工作即可。
* 如果协调器没有收到有效的PM票据，那么就不要执行工作，也不要返回任何输出。
    * 协议将包含针对某些错误条件的消息，比如`LowPMBalance`或`SegmentFormatDidntMatchJobInputParams`，以便广播器可以接收一些有用的信息进行调试，或者让它们的节点可以做出诸如重新填充余额之类的决策。
* 协调器监控广播公司的存款并评估违约风险。.
    * 首先是简单的算法。如果他们的平衡太低，就停止工作。
    * 协调器在收到中奖彩票时兑现(或者等到gas更便宜时，评估违约风险)。
    
有关票证数据结构的全面分析和规范、防止双重开支以及其他设计考虑事项，请参阅本文[外部文档](https://hackmd.io/uHMFeNSyS_GyzwnO3Ld74A?view).

## 参考文献 ###########################################

1. Livepeer白皮书 - Doug Petkanics, Eric Tang - <https://github.com/livepeer/wiki/blob/master/WHITEPAPER.md>
2. 视频的矿工, A Path To Scaling Video Transcoding -Philipp Angele  - <https://medium.com/livepeer-blog/the-video-miner-a-path-to-scaling-video-transcoding-a3487d232a1>
3. Ethereum概率小额支付 - Gustav Simonson - <https://medium.com/@gustav.simonsson/ethereum-probabilistic-micropayments-ae6e6cd85a06>
4. 电子彩票作为小额支付 - Ron Rivest - MIT Lab for Computer Science - <https://people.csail.mit.edu/rivest/pubs/Riv97b.pdf>
5. 分散的匿名小额支付 - A. Chiesa, M. Green, J. Liu, P. Miao, I. Miers and P. Mishra - <https://eprint.iacr.org/2016/1033.pdf>


